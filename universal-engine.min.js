(function(){"use strict";function e(e){for(;e&&e!==document;){if(e.classList&&e.classList.contains("ue-question"))return e;e=e.parentNode}return null}function t(){for(var t=document.querySelectorAll(".ue-option"),n=0;n<t.length;n++)!function(t){t.addEventListener("click",function(){var n=t.getAttribute("data-question-id")||"";if(!n)return;for(var a=document.querySelectorAll('.ue-option[data-question-id="'+n+'"]'),r=0;r<a.length;r++)a[r].classList.remove("ue-selected"),a[r].style.backgroundColor="",a[r].style.borderColor="";t.classList.add("ue-selected");var i=(""+(t.getAttribute("data-correct")||"")).toLowerCase()==="true";i?(t.style.backgroundColor="#dcfce7",t.style.borderColor="#16a34a"):(t.style.backgroundColor="#fee2e2",t.style.borderColor="#dc2626");var o=e(t);o&&(o.setAttribute("data-is-correct",i?"true":"false"),o.setAttribute("data-selected-option-id",t.getAttribute("data-option-id")||""))})}(t[n])}function n(e){var t=e.getAttribute("data-correct-order")||"";if(!t)return;for(var n=t.split(","),a=0;a<n.length;a++)n[a]=n[a].replace(/^\s+|\s+$/g,"");for(var r=e.querySelectorAll(".ue-dnd-item"),i=[],o=0;o<r.length;o++){var c=(r[o].getAttribute("data-value")||"").replace(/^\s+|\s+$/g,"");i.push(c)}var l=i.length===n.length;if(l)for(var s=0;s<n.length;s++)if(i[s]!==n[s]){l=!1;break}l?(e.style.outline="2px solid #16a34a",e.style.boxShadow="0 0 0 4px rgba(22,163,74,0.20)",e.setAttribute("data-is-correct","true")):(e.style.outline="2px solid #dc2626",e.style.boxShadow="0 0 0 4px rgba(220,38,38,0.20)",e.setAttribute("data-is-correct","false"))}function a(e,t,n){var a=e.querySelectorAll(".ue-dnd-item:not(.ue-dragging)");if(!a.length)return null;for(var r=null,i=1/0,o=0;o<a.length;o++){var c=a[o].getBoundingClientRect(),l=c.left+c.width/2,s=c.top+c.height/2,u=t-l,d=n-s,f=u*u+d*d;f<i&&(i=f,r=a[o])}return r}function r(){for(var e=document.querySelectorAll(".ue-dnd-container"),t=0;t<e.length;t++)!function(e){var t=e.querySelector(".ue-dnd-list")||e.querySelector("ul")||e.querySelector("ol");if(!t)return;for(var r=t.querySelectorAll(".ue-dnd-item"),i=0;i<r.length;i++)!function(e){e.draggable=!0,e.addEventListener("dragstart",function(t){e.classList.add("ue-dragging");try{t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/plain",e.getAttribute("data-value")||"")}catch(e){}}),e.addEventListener("dragend",function(){e.classList.remove("ue-dragging")})}(r[i]);t.addEventListener("dragover",function(e){e.preventDefault();var n=t.querySelector(".ue-dragging");if(!n)return;var r=a(t,e.clientX,e.clientY);null==r?t.appendChild(n):r!==n&&t.insertBefore(n,r)}),t.addEventListener("drop",function(t){t.preventDefault(),n(e)})}(e[t])}function i(e){for(var t=e;t&&t!==document;){if(t.hasAttribute&&t.hasAttribute("data-skill"))return t.getAttribute("data-skill")||"";t=t.parentNode}return""}function o(e){return(e||"").replace(/^\s+|\s+$/g,"")}function c(e){if(!e)return[];for(var t=e.split(","),n=[],a=0;a<t.length;a++){var r=o(t[a]);r&&n.push(r)}return n}function l(e){return o(e).toLowerCase()}function s(){var e=document.getElementById("testSec");if(!e)return{correct:0,total:0,details:[],skills:{}};for(var t=e.querySelectorAll(".mcq[data-answer]"),n=0,a=0,r=[],s={},u=0;u<t.length;u++){var d=t[u],f=o(d.getAttribute("data-answer")||"");if(f){n++;var v=d.querySelector("button.selected"),h=v?o(v.getAttribute("data-choice")||""):"",g=!!h&&h===f;g&&a++;var m=i(d);m&&(s[m]||(s[m]={correct:0,total:0}),s[m].total++,g&&s[m].correct++),r.push({type:"mcq",index:u+1,correctChoice:f,selectedChoice:h||null,isCorrect:g})}}return{correct:a,total:n,details:r,skills:s}}function u(){var e=document.getElementById("testSec");if(!e)return{correct:0,total:0,details:[],skills:{}};for(var t=e.querySelectorAll(".ue-dnd-container[data-correct-order]"),a=0,r=0,s=[],u={},d=0;d<t.length;d++){var f=t[d];n(f);var v=(""+(f.getAttribute("data-is-correct")||"")).toLowerCase()==="true";a++,v&&r++;var h=i(f);h&&(u[h]||(u[h]={correct:0,total:0}),u[h].total++,v&&u[h].correct++);var g=f.getAttribute("data-label")||"DnD "+(d+1),m=f.getAttribute("data-correct-order")||"",p=c(m),y=f.querySelectorAll(".ue-dnd-item"),b=[];if(y)for(var w=0;w<y.length;w++)b.push(o(y[w].getAttribute("data-value")||""));s.push({type:"dnd",index:d+1,label:g,isCorrect:v,correctOrder:p,userOrder:b})}return{correct:r,total:a,details:s,skills:u}}function d(){var e=document.getElementById("testSec");if(!e)return{correct:0,total:0,details:[],skills:{}};for(var t=e.querySelectorAll(".sortable[data-correct]"),n=0,a=0,r=[],s={},u=0;u<t.length;u++){var d=t[u],f=c(d.getAttribute("data-correct")||"");if(f.length){n++;for(var v=d.querySelectorAll(".tile[data-value]"),h=[],g=0;g<v.length;g++)h.push(o(v[g].getAttribute("data-value")||""));var m=h.length===f.length;if(m)for(var p=0;p<f.length;p++)if(h[p]!==f[p]){m=!1;break}m&&a++;var y=i(d);y&&(s[y]||(s[y]={correct:0,total:0}),s[y].total++,m&&s[y].correct++);var b=d.getAttribute("data-label")||"Order "+(u+1);r.push({type:"sortable",index:u+1,label:b,isCorrect:m,correctOrder:f,userOrder:h})}}return{correct:a,total:n,details:r,skills:s}}function f(){var e=document.getElementById("testSec");if(!e)return{correct:0,total:0,details:[],skills:{}};for(var t=e.querySelectorAll(".short[data-answer]"),n=0,a=0,r=[],s={},u=0;u<t.length;u++){var d=t[u],f=d.getAttribute("data-answer")||"";if(f){n++;for(var v=f.split(/[\|,]/),h=[],g=0;g<v.length;g++){var m=l(v[g]);m&&h.push(m)}var p=d.querySelector("input, textarea"),y=p?p.value:"",b=l(y),w=!1;for(var E=0;E<h.length;E++)if(b&&b===h[E]){w=!0;break}w&&a++;var S=i(d);S&&(s[S]||(s[S]={correct:0,total:0}),s[S].total++,w&&s[S].correct++);var k=d.getAttribute("data-label")||"Short "+(u+1);r.push({type:"short",index:u+1,label:k,isCorrect:w,userAnswer:y,correctAnswers:h})}}return{correct:a,total:n,details:r,skills:s}}function v(){var e=document.getElementById("testSec");if(!e)return{correct:0,total:0,details:[],skills:{}};for(var t=e.querySelectorAll(".compare-row[data-kind='cmp'][data-answer]"),n=0,a=0,r=[],s={},u=0;u<t.length;u++){var d=t[u],f=o(d.getAttribute("data-answer")||"");if(f){n++;var v=o(d.getAttribute("data-user-answer")||""),h=!!v&&v===f;h&&a++;var g=i(d);g&&(s[g]||(s[g]={correct:0,total:0}),s[g].total++,h&&s[g].correct++);var m=d.getAttribute("data-label")||"Compare "+(u+1);r.push({type:"compare",index:u+1,label:m,isCorrect:h,correctOperator:f,userOperator:v||null})}}return{correct:a,total:n,details:r,skills:s}}function h(e,t){if(t){for(var n=Object.keys(t),a=0;a<n.length;a++){var r=n[a],i=t[r];e[r]||(e[r]={correct:0,total:0}),e[r].correct+=i.correct,e[r].total+=i.total}}}function g(){var e=s(),t=u(),n=d(),a=f(),r=v(),i=e.correct+t.correct+n.correct+a.correct+r.correct,o=e.total+t.total+n.total+a.total+r.total,c=[].concat(e.details,t.details,n.details,a.details,r.details),l={};return h(l,e.skills),h(l,t.skills),h(l,n.skills),h(l,a.skills),h(l,r.skills),{correct:i,total:o,details:c,skills:l}}function m(e){if(!e||!e.total)return"";for(var t=Math.round(e.correct/e.total*100),n=[],a=e.skills||{},r=Object.keys(a),i=0;i<r.length;i++){var o=r[i],c=a[o];n.push("Skill: "+o+" â€” "+c.correct+"/"+c.total)}return n.unshift("Score: "+e.correct+"/"+e.total+" ("+t+"%)"),n.join("\n")}function p(e){if(!e||!e.details)return"";for(var t=[],n=0;n<e.details.length;n++){var a=e.details[n];"mcq"===a.type?t.push("[MCQ Q"+a.index+"] "+(a.selectedChoice||"-")+" (Ans: "+a.correctChoice+")"):"dnd"===a.type?t.push("[DnD "+a.index+"] "+a.userOrder.join(" | ")+" (Ans: "+a.correctOrder.join(" | ")+")"):"sortable"===a.type?t.push("[Sort "+a.index+"] "+a.userOrder.join(" | ")+" (Ans: "+a.correctOrder.join(" | ")+")"):"short"===a.type?t.push("[Short "+a.index+"] "+(a.userAnswer||"-")+" (Ans: "+a.correctAnswers.join(" | ")+")"):"compare"===a.type?t.push("[Compare "+a.index+"] "+(a.userOperator||"-")+" (Ans: "+a.correctOperator+")"):t.push("[Q"+a.index+"] (untyped)")}return t.join("\n")}function y(e){var t=document.getElementById("hiddenMarks"),n=document.getElementById("hiddenAnswers");t&&(t.value=m(e)),n&&(n.value=p(e))}function b(e){if(e&&"function"==typeof window.storeState){var t={activityId:"string"==typeof window.ACTIVITY_ID?window.ACTIVITY_ID:"",score:{correct:e.correct,total:e.total,percent:e.total?Math.round(e.correct/e.total*100):null},details:e.details,skills:e.skills,submittedAt:new Date().toISOString()};try{window.storeState(t)}catch(e){console.error("Error calling storeState from Universal Engine:",e)}}}function w(){var e=document.getElementById("testSubmitBtn");e&&e.addEventListener("click",function(){if(window.__ueFirstTestSubmitDone)return;window.__ueFirstTestSubmitDone=!0;var t=g();y(t),b(t)})}function E(){t(),r(),w()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",E):E()})();
